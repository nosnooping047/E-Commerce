
{% extends 'conteudo.html' %}
{% load custom_filters %}
{% load static %}

{% block 'cabecalho' %}
    <script src="https://sdk.mercadopago.com/js/v2"></script>
{% endblock %}
{% block 'principal_1' %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-5">
            <h2>Seu Carrinho</h2>
            {% for produto, quantidade in produtos_no_carrinho %}
                <div class="card mb-3">
                    <div class="card-body">
                        <h3 class="card-title">{{ produto.nome }}</h3>
                        <p class="card-text">{{ produto.descricao }}</p>
                        <p class="card-text"><strong>Quantidade:</strong> {{ quantidade }}</p>
                        <p class="card-text"><strong>Preço unitário:</strong> R$ {{ produto.valor_venda }}</p>
                        <p class="card-text"><strong>Preço total:</strong> R$ {{ produto.valor_venda|mul:quantidade }}</p>
                        <form action="{% url 'carrinho' %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="produto_id" value="{{ produto.id }}">
                            <input type="hidden" name="quantidade_atual" value="{{ quantidade }}">
                            <button type="submit" name="remover_carrinho" class="btn btn-sm btn-warning">-</button>

                            <input type="hidden" name="adicionar_carrinho" value="{{ produto.id }}">
                            <button type="submit" class="btn btn-sm btn-success">+</button>
                        </form>  
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="col-md-7">
            <p><strong>Valor Total do Carrinho:</strong> R$ {{ valor_total }}</p>
            <p><strong>Total de itens:</strong> {{ request.session.cart|length }}</p>
            
            <div id="paymentBrick_container"></div>
            <div id="url-data" data-url="{% url 'process_payment' %}"></div>

            {% csrf_token %}
            <script>
              
            const urlElement = document.getElementById('url-data');
            const urlCarrinho = urlElement.getAttribute('data-url');
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const preferenceId = "{{ preferencia_id }}"; // Acesse o preferencia_id do contexto do template
            console.log("Preferencia ID:", preferenceId);
              function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        // Verifica se este cookie é o que estamos procurando
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const mp = new MercadoPago('TEST-2df1cf56-0a67-4d60-b88a-ddd3e06048e3', {
              locale: 'pt-BR'
            });
            const bricksBuilder = mp.bricks();
    const renderPaymentBrick = async (bricksBuilder) => {
      const settings = {
        initialization: {
          /*
            "amount" é a quantia total a pagar por todos os meios de pagamento com exceção da Conta Mercado Pago e Parcelas sem cartão de crédito, que têm seus valores de processamento determinados no backend através do "preferenceId"
          */
          amount: 10000,
          preferenceId: preferenceId,
          payer: {
            firstName: "tech",
            lastName: "anony",
            email: "anonytechtech@gmail.com",
          },
        },
        customization: {
          visual: {
            style: {
              theme: "default",
            },
          },
          paymentMethods: {
            creditCard: "all",
										debitCard: "all",
										ticket: "all",
										bankTransfer: "all",
										atm: "all",
										onboarding_credits: "all",
										wallet_purchase: "all",
            maxInstallments: 12
          },
        },
        callbacks: {
          onReady: () => {
            /*
             Callback chamado quando o Brick está pronto.
             Aqui, você pode ocultar seu site, por exemplo.
            */
          },
          onSubmit: ({ selectedPaymentMethod, formData }) => {
            // callback chamado quando há click no botão de envio de dados
            
            
            
            console.log(csrftoken);
            return new Promise((resolve, reject) => {
              // var csrftoken = getCookie('csrftoken');
              fetch(urlCarrinho, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": csrftoken
                },
                body: JSON.stringify(formData),
              })
                .then((response) => response.json())
                .then((response) => {
                  // receber o resultado do pagamento
                  console.log("Resposta do servidor:", response);
                  resolve();
                })
                .catch((error) => {
                  // manejar a resposta de erro ao tentar criar um pagamento
                  console.error("Erro ao fazer a requisição:", error);
                  reject();
                });
            });
          },
          onError: (error) => {
            // callback chamado para todos os casos de erro do Brick
            console.error(error);
          },
        },
      };
      window.paymentBrickController = await bricksBuilder.create(
        "payment",
        "paymentBrick_container",
        settings
      );
    };

    window.addEventListener('beforeunload', function(event) {
    if (window.paymentBrickController) {
        window.paymentBrickController.unmount();
    }
});

window.addEventListener('load', function(event) {
    if (!window.paymentBrickController) {
        renderPaymentBrick(bricksBuilder);
    }
}); 

  </script>
        </div>
    </div>
</div>



  
    

{% endblock %}